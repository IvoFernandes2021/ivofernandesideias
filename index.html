<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ivo Fernandes | Engenharia, IA & Inovação</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      background-color: #f4f7f9;
      color: #1a202c;
      font-family: 'Poppins', sans-serif;
    }
    .text-primary { color: #2563eb; }
    .bg-primary { background-color: #2563eb; }
  </style>
</head>
<body>
  <main class="max-w-4xl mx-auto p-6 space-y-6">
    <h1 class="text-4xl font-bold text-primary">Assistente de Comandos Civil 3D</h1>
    <p class="text-lg">Converse com a IA para obter explicações, exemplos práticos e ilustrações de comandos.</p>

    <div id="chat-window" class="flex flex-col gap-2 p-4 bg-white rounded shadow h-96 overflow-y-auto border border-gray-200"></div>

    <div class="flex gap-2 items-center mt-4">
      <input id="chat-input" class="flex-grow p-3 rounded border" placeholder="Digite um comando ou uma pergunta..." />
      <button id="chat-send-button" class="bg-primary text-white px-4 py-2 rounded">Enviar</button>
    </div>

    <div id="chat-loading-indicator" class="text-sm text-gray-500 hidden">⏳ IA está gerando a resposta...</div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const chatWindow = document.getElementById('chat-window');
      const chatInput = document.getElementById('chat-input');
      const chatSendButton = document.getElementById('chat-send-button');
      const chatLoadingIndicator = document.getElementById('chat-loading-indicator');

      function addChatMessage(message, sender) {
        const bubble = document.createElement('div');
        bubble.className = `p-3 rounded-lg max-w-[80%]`;
        bubble.classList.add(sender === 'user' ? 'bg-primary text-white self-end' : 'bg-blue-100 text-blue-800 self-start');
        bubble.textContent = message;
        chatWindow.appendChild(bubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      async function callGemini(prompt) {
        const apiUrl = `/api/gemini`;
        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(`API request failed: ${errorData.message}`);
          }

          const result = await response.json();
          return result.resposta || 'Resposta vazia ou mal formatada pela IA.';
        } catch (error) {
          console.error('Erro ao chamar a função de proxy:', error);
          return `Erro: ${error.message}`;
        }
      }

      async function handleChatSend() {
        const userInput = chatInput.value.trim();
        if (!userInput) return;
        addChatMessage(userInput, 'user');
        chatInput.value = '';
        chatLoadingIndicator.classList.remove('hidden');
        const aiResponse = await callGemini(userInput);
        chatLoadingIndicator.classList.add('hidden');
        addChatMessage(aiResponse, 'ia');
      }

      chatSendButton.addEventListener('click', handleChatSend);
      chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatSend(); });
    });
  </script>
</body>
</html>
